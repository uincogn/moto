import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../services/database_service.dart';
import '../services/theme_service.dart';
import '../services/backup_service.dart';
import '../services/api_service.dart';
import '../theme/app_theme.dart';
import '../widgets/modern_card.dart';

class ConfiguracoesScreen extends StatefulWidget {
  const ConfiguracoesScreen({super.key});

  @override
  State<ConfiguracoesScreen> createState() => _ConfiguracoesScreenState();
}

class _ConfiguracoesScreenState extends State<ConfiguracoesScreen> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  final DatabaseService _db = DatabaseService.instance;

  List<String> _categoriasGastos = [];
  List<String> _tiposManutencao = [];
  Map<String, int> _intervalosManutencao = {};
  final _novaCategoria = TextEditingController();
  final _novoTipo = TextEditingController();

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _loadConfiguracoes();
  }

  @override
  void dispose() {
    _tabController.dispose();
    _novaCategoria.dispose();
    _novoTipo.dispose();
    super.dispose();
  }

  Future<void> _loadConfiguracoes() async {
    _categoriasGastos = await _db.getCategoriasGastos();
    _tiposManutencao = await _db.getTiposManutencao();
    _intervalosManutencao = await _db.getAllIntervalosManutencao();
    setState(() {});
  }

  Future<void> _adicionarCategoria() async {
    if (_novaCategoria.text.isNotEmpty) {
      _categoriasGastos.add(_novaCategoria.text);
      await _db.setCategoriasGastos(_categoriasGastos);
      _novaCategoria.clear();
      setState(() {});
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Categoria adicionada com sucesso!')),
      );
    }
  }

  Future<void> _removerCategoria(String categoria) async {
    _categoriasGastos.remove(categoria);
    await _db.setCategoriasGastos(_categoriasGastos);
    setState(() {});
    if (!context.mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Categoria removida com sucesso!')),
    );
  }

  Future<void> _adicionarTipo() async {
    if (_novoTipo.text.isNotEmpty) {
      _tiposManutencao.add(_novoTipo.text);
      await _db.setTiposManutencao(_tiposManutencao);
      // Adicionar intervalo padr√£o de 5000 km para o novo tipo
      await _db.setIntervaloManutencao(_novoTipo.text, 5000);
      _intervalosManutencao[_novoTipo.text] = 5000;
      _novoTipo.clear();
      setState(() {});
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Tipo de manuten√ß√£o adicionado com sucesso!')),
      );
    }
  }

  Future<void> _removerTipo(String tipo) async {
    _tiposManutencao.remove(tipo);
    await _db.setTiposManutencao(_tiposManutencao);
    _intervalosManutencao.remove(tipo);
    setState(() {});
    if (!context.mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Tipo removido com sucesso!')),
    );
  }

  Future<void> _editarIntervaloManutencao(String tipo, int intervaloAtual) async {
    final TextEditingController controller = TextEditingController(text: intervaloAtual.toString());

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Editar Intervalo - $tipo'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text('Defina o intervalo em quil√¥metros para $tipo:'),
            const SizedBox(height: 16),
            TextFormField(
              controller: controller,
              decoration: const InputDecoration(
                labelText: 'Intervalo (km)',
                border: OutlineInputBorder(),
                suffixText: 'km',
              ),
              keyboardType: TextInputType.number,
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancelar'),
          ),
          ElevatedButton(
            onPressed: () async {
              final novoIntervalo = int.tryParse(controller.text);
              if (novoIntervalo != null && novoIntervalo > 0) {
                await _db.setIntervaloManutencao(tipo, novoIntervalo);
                _intervalosManutencao[tipo] = novoIntervalo;
                setState(() {});
                Navigator.pop(context);
                if (!context.mounted) return;
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(content: Text('Intervalo de $tipo atualizado para $novoIntervalo km')),
                );
              }
            },
            child: const Text('Salvar'),
          ),
        ],
      ),
    );
  }

  // Fun√ß√£o _exportarDados removida - n√£o utilizada

  Future<void> _shareModernBackup() async {
    try {
      await BackupService.shareBackup();
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('‚úÖ Backup compartilhado com sucesso!')),
      );
    } catch (e) {
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('‚ùå Erro ao criar backup: $e')),
      );
    }
  }

  // Fun√ß√£o _restoreBackup removida - n√£o utilizada

  void _showTechInfo() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('üöÄ Tecnologia'),
        content: const Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('Framework: Flutter 3.24+'),
            Text('Linguagem: Dart'),
            Text('Banco: SQLite local'),
            Text('Gr√°ficos: FL Chart'),
            Text('Estilo: Material Design 3'),
            Text('Tema: Grau 244 - Visual jovem motociclista'),
            SizedBox(height: 16),
            Text('Caracter√≠sticas:'),
            Text('‚Ä¢ 100% offline'),
            Text('‚Ä¢ Dados locais seguros'),
            Text('‚Ä¢ Interface nativa'),
            Text('‚Ä¢ Performance otimizada'),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Fechar'),
          ),
        ],
      ),
    );
  }

  Future<void> _clearCache() async {
    try {
      // Simula√ß√£o de limpeza de cache
      await Future.delayed(const Duration(seconds: 1));
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('üßπ Cache limpo com sucesso!')),
      );
    } catch (e) {
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('‚ùå Erro ao limpar cache: $e')),
      );
    }
  }

  Future<void> _refreshData() async {
    try {
      await _loadConfiguracoes();
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('üîÑ Dados atualizados com sucesso!')),
      );
    } catch (e) {
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('‚ùå Erro ao atualizar dados: $e')),
      );
    }
  }

  /// Lida com o clique em "Backup na Nuvem" - verifica login automaticamente
  Future<void> _handleCloudBackup() async {
    try {
      // Verificar se o usu√°rio est√° logado
      final isLoggedIn = await ApiService.isLoggedIn();
      
      if (!isLoggedIn) {
        // Mostrar dialog perguntando se quer fazer login
        final shouldLogin = await showDialog<bool>(
          context: context,
          builder: (context) => AlertDialog(
            title: const Text('Login Necess√°rio'),
            content: const Text(
              'Para usar o backup na nuvem, voc√™ precisa estar logado. '
              'Deseja fazer login agora?'
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context, false),
                child: const Text('Cancelar'),
              ),
              ElevatedButton(
                onPressed: () => Navigator.pop(context, true),
                child: const Text('Fazer Login'),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppTheme.primaryColor,
                  foregroundColor: Colors.white,
                ),
              ),
            ],
          ),
        );

        if (shouldLogin == true) {
          // Navegar para tela de login
          final loginResult = await Navigator.pushNamed(context, '/login');
          if (loginResult == true) {
            // Login bem-sucedido, ir para sync
            if (!context.mounted) return;
            Navigator.pushNamed(context, '/sync');
          }
        }
      } else {
        // Usu√°rio j√° est√° logado, ir direto para sync
        Navigator.pushNamed(context, '/sync');
      }
    } catch (e) {
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Erro ao verificar login: $e')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('‚öôÔ∏è Configura√ß√µes'),
        bottom: TabBar(
          controller: _tabController,
          tabs: const [
            Tab(text: 'Geral'),
            Tab(text: 'Categorias'),
            Tab(text: 'Backup'),
          ],
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: [
          _buildGeralTab(),
          _buildCategoriasTab(),
          _buildBackupTab(),
        ],
      ),
    );
  }

  Widget _buildGeralTab() {
    return Consumer<ThemeService>(
      builder: (context, themeService, child) {
        return SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Se√ß√£o Apar√™ncia
              const Text(
                'üé® Apar√™ncia',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 12),

              ModernCard(
                child: Column(
                  children: [
                    ListTile(
                      leading: Icon(
                        themeService.isDarkMode ? Icons.dark_mode : Icons.light_mode,
                        color: AppTheme.primaryColor,
                      ),
                      title: const Text('Modo Escuro'),
                      subtitle: Text(
                        themeService.themeMode == ThemeMode.system
                            ? 'Autom√°tico (segue o sistema)'
                            : themeService.isDarkMode
                                ? 'Ativado'
                                : 'Desativado',
                      ),
                      trailing: Switch.adaptive(
                        value: themeService.themeMode == ThemeMode.dark ||
                            (themeService.themeMode == ThemeMode.system &&
                                MediaQuery.of(context).platformBrightness ==
                                    Brightness.dark),
                        onChanged: (value) {
                          themeService.setThemeMode(
                            value ? ThemeMode.dark : ThemeMode.light,
                          );
                        },
                        activeColor: AppTheme.primaryColor,
                      ),
                    ),
                    const Divider(height: 1),
                    ListTile(
                      leading: const Icon(
                        Icons.auto_mode,
                        color: AppTheme.secondaryColor,
                      ),
                      title: const Text('Modo Autom√°tico'),
                      subtitle: const Text('Segue as configura√ß√µes do sistema'),
                      trailing: Switch.adaptive(
                        value: themeService.themeMode == ThemeMode.system,
                        onChanged: (value) {
                          themeService.setThemeMode(
                            value ? ThemeMode.system : ThemeMode.light,
                          );
                        },
                        activeColor: AppTheme.secondaryColor,
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Se√ß√£o App Info
              const Text(
                '‚ÑπÔ∏è Informa√ß√µes do App',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 12),

              ModernCard(
                child: Column(
                  children: [
                    const ListTile(
                      leading: Icon(Icons.info, color: AppTheme.primaryColor),
                      title: Text('Vers√£o'),
                      subtitle: Text('2.0.0 - Est√©tica Grau 244'),
                    ),
                    const Divider(height: 1),
                    const ListTile(
                      leading: Icon(Icons.motorcycle, color: AppTheme.accentColor),
                      title: Text('Motouber'),
                      subtitle: Text('Controle financeiro para motociclistas'),
                    ),
                    const Divider(height: 1),
                    ListTile(
                      leading: const Icon(Icons.code, color: AppTheme.secondaryColor),
                      title: const Text('Tecnologia'),
                      subtitle: const Text('Flutter/Dart + SQLite'),
                      onTap: () => _showTechInfo(),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Se√ß√£o Conta e Sincroniza√ß√£o
              const Text(
                '‚òÅÔ∏è Conta e Sincroniza√ß√£o',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 12),

              ModernCard(
                child: Column(
                  children: [
                    ListTile(
                      leading: const Icon(Icons.login, color: AppTheme.primaryColor),
                      title: const Text('Login'),
                      subtitle: const Text('Fazer login para recursos premium'),
                      trailing: const Icon(Icons.chevron_right),
                      onTap: () => Navigator.pushNamed(context, '/login'),
                    ),
                    const Divider(height: 1),
                    ListTile(
                      leading: const Icon(Icons.cloud_sync, color: AppTheme.secondaryColor),
                      title: const Text('Backup na Nuvem'),
                      subtitle: const Text('Sincronizar dados com a nuvem'),
                      trailing: const Icon(Icons.chevron_right),
                      onTap: () => _handleCloudBackup(),
                    ),
                    const Divider(height: 1),
                    ListTile(
                      leading: const Icon(Icons.star, color: AppTheme.accentColor),
                      title: const Text('Premium'),
                      subtitle: const Text('Recursos avan√ßados'),
                      trailing: const Icon(Icons.chevron_right),
                      onTap: () => Navigator.pushNamed(context, '/premium'),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Se√ß√£o Performance
              const Text(
                '‚ö° Performance',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 12),

              ModernCard(
                child: Column(
                  children: [
                    ListTile(
                      leading: const Icon(Icons.storage, color: AppTheme.warningColor),
                      title: const Text('Limpar Cache'),
                      subtitle: const Text('Remove dados tempor√°rios'),
                      trailing: const Icon(Icons.chevron_right),
                      onTap: () => _clearCache(),
                    ),
                    const Divider(height: 1),
                    ListTile(
                      leading: const Icon(Icons.refresh, color: AppTheme.primaryColor),
                      title: const Text('Recarregar Dados'),
                      subtitle: const Text('Atualiza informa√ß√µes do banco'),
                      trailing: const Icon(Icons.chevron_right),
                      onTap: () => _refreshData(),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildCategoriasTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Categorias de Gastos
          const Text(
            'Categorias de Gastos',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 16),

          Row(
            children: [
              Expanded(
                child: TextField(
                  controller: _novaCategoria,
                  decoration: const InputDecoration(
                    labelText: 'Nova categoria',
                    border: OutlineInputBorder(),
                  ),
                ),
              ),
              const SizedBox(width: 8),
              ElevatedButton(
                onPressed: _adicionarCategoria,
                child: const Text('Adicionar'),
              ),
            ],
          ),

          const SizedBox(height: 16),

          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: _categoriasGastos.map((categoria) {
              return Chip(
                label: Text(categoria),
                onDeleted: () => _removerCategoria(categoria),
                backgroundColor: AppTheme.primaryColor.withAlpha((255 * 0.1).toInt()),
              );
            }).toList(),
          ),

          const SizedBox(height: 32),

          // Tipos de Manuten√ß√£o
          const Text(
            'Tipos de Manuten√ß√£o',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 16),

          Row(
            children: [
              Expanded(
                child: TextField(
                  controller: _novoTipo,
                  decoration: const InputDecoration(
                    labelText: 'Novo tipo',
                    border: OutlineInputBorder(),
                  ),
                ),
              ),
              const SizedBox(width: 8),
              ElevatedButton(
                onPressed: _adicionarTipo,
                child: const Text('Adicionar'),
              ),
            ],
          ),

          const SizedBox(height: 16),

          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: _tiposManutencao.map((tipo) {
              return Chip(
                label: Text(tipo),
                onDeleted: () => _removerTipo(tipo),
                backgroundColor: AppTheme.warningColor.withAlpha((255 * 0.1).toInt()),
              );
            }).toList(),
          ),

          const SizedBox(height: 32),

          // Intervalos de Manuten√ß√£o Personaliz√°veis
          const Text(
            'Intervalos de Manuten√ß√£o (km)',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 16),

          if (_intervalosManutencao.isEmpty)
            const Card(
              child: Padding(
                padding: EdgeInsets.all(16),
                child: Text(
                  'Carregando intervalos de manuten√ß√£o...',
                  style: TextStyle(color: Colors.grey),
                ),
              ),
            )
          else
            Column(
              children: _intervalosManutencao.entries.map((entry) {
                return Card(
                  margin: const EdgeInsets.only(bottom: 8),
                  child: ListTile(
                    leading: const Icon(Icons.settings, color: AppTheme.primaryColor),
                    title: Text(entry.key),
                    subtitle: Text('Intervalo: ${entry.value} km'),
                    trailing: IconButton(
                      icon: const Icon(Icons.edit, color: AppTheme.secondaryColor),
                      onPressed: () => _editarIntervaloManutencao(entry.key, entry.value),
                    ),
                  ),
                );
              }).toList(),
            ),
        ],
      ),
    );
  }

  Widget _buildBackupTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'üíæ Backup e Restaura√ß√£o',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 16),

          ModernCard(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Icon(Icons.cloud_upload, color: AppTheme.primaryColor),
                    SizedBox(width: 12),
                    Text(
                      'Backup Avan√ßado',
                      style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                const Text(
                  'Sistema completo de backup com todos os seus dados: trabalhos, gastos, manuten√ß√µes e configura√ß√µes.',
                ),
                const SizedBox(height: 16),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: () => _shareModernBackup(),
                    icon: const Icon(Icons.share),
                    label: const Text('Compartilhar Backup'),
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 16),

          Card(
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'Limpar Dados',
                    style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                  ),
                  const SizedBox(height: 8),
                  const Text(
                    'Aten√ß√£o: Esta a√ß√£o remover√° todos os dados permanentemente!',
                    style: TextStyle(color: Colors.red),
                  ),
                  const SizedBox(height: 16),
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton.icon(
                      onPressed: _showClearDataDialog,
                      icon: const Icon(Icons.delete_forever),
                      label: const Text('Limpar Todos os Dados'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.red,
                        foregroundColor: Colors.white,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Fun√ß√£o _buildSobreTab removida - n√£o utilizada

  void _showClearDataDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Confirmar Limpeza'),
        content: const Text(
          'Esta a√ß√£o remover√° todos os dados permanentemente. Tem certeza que deseja continuar?',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancelar'),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context);
              _clearAllData();
            },
            child: const Text('Limpar Dados', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );
  }

  Future<void> _clearAllData() async {
    try {
      // Aqui voc√™ implementaria a limpeza do banco de dados
      // Por exemplo, deletar todas as tabelas e recriar

      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Todos os dados foram removidos!')),
      );
    } catch (e) {
      if (!context.mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Erro ao limpar dados: $e')),
      );
    }
  }
}